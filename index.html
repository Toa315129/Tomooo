<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TOMOPHOTO</title>

<style>
    body{
        margin:0;
        background:#2b1b12;
        font-family: "Arial", sans-serif;
        display:flex;
        justify-content:center;
        align-items:center;
        height:100vh;
        color:#fff;
    }

    .booth{
        width:420px;
        background:#f3ece5;
        border-radius:20px;
        padding:20px;
        text-align:center;
        box-shadow:0 20px 40px rgba(0,0,0,.4);
        color:#5b3a29;
    }

    h1{
        margin:5px 0 15px;
        letter-spacing:4px;
    }

    .camera-box{
        position:relative;
    }

    video{
        width:100%;
        border-radius:16px;
        border:6px solid #5b3a29;
    }

    .countdown{
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%,-50%);
        font-size:120px;
        font-weight:bold;
        color:#fff;
        text-shadow:0 0 20px #000;
        display:none;
    }

    button{
        margin-top:12px;
        width:100%;
        padding:14px;
        font-size:18px;
        border:none;
        border-radius:12px;
        background:#8c6b4e;
        color:#fff;
        cursor:pointer;
    }

    button:hover{
        background:#6f533f;
    }

    .strip{
        margin-top:15px;
    }

    canvas{
        width:100%;
        border-radius:12px;
        border:4px solid #5b3a29;
        display:none;
    }

    a{
        display:none;
        margin-top:12px;
        padding:12px;
        background:#8c6b4e;
        color:#fff;
        text-decoration:none;
        border-radius:10px;
    }
</style>
</head>

<body>

<div class="booth">
    <h1>TOMOPHOTO</h1>

    <div class="camera-box">
        <video id="video" autoplay playsinline></video>
        <div class="countdown" id="countdown">3</div>
    </div>

    <button id="startBtn">START</button>

    <div class="strip">
        <canvas id="result"></canvas>
        <a id="download" download="TOMOPHOTO.png">DOWNLOAD</a>
    </div>
</div>

<script>
const video = document.getElementById("video");
const countdownEl = document.getElementById("countdown");
const startBtn = document.getElementById("startBtn");
const result = document.getElementById("result");
const download = document.getElementById("download");

const ctx = result.getContext("2d");
const hiddenCanvas = document.createElement("canvas");
const hctx = hiddenCanvas.getContext("2d");

let photos = [];

async function startCamera(){
    const stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:"user" }
    });
    video.srcObject = stream;
}

function countdown(){
    return new Promise(resolve=>{
        let num = 3;
        countdownEl.style.display = "block";
        countdownEl.textContent = num;

        const timer = setInterval(()=>{
            num--;
            if(num === 0){
                clearInterval(timer);
                countdownEl.style.display = "none";
                resolve();
            }else{
                countdownEl.textContent = num;
            }
        },1000);
    });
}

function takePhoto(){
    hiddenCanvas.width = video.videoWidth;
    hiddenCanvas.height = video.videoHeight;
    hctx.drawImage(video,0,0);
    photos.push(hiddenCanvas.toDataURL("image/png"));
}

async function startBooth(){
    photos = [];
    startBtn.disabled = true;

    for(let i=0;i<3;i++){
        await countdown();
        takePhoto();
        await new Promise(r=>setTimeout(r,500));
    }

    buildStrip();
    startBtn.disabled = false;
}

function buildStrip(){
    const w = hiddenCanvas.width;
    const h = hiddenCanvas.height;

    result.width = w;
    result.height = h * 3;

    photos.forEach((src,i)=>{
        const img = new Image();
        img.onload = ()=>{
            ctx.drawImage(img,0,h*i,w,h);
            if(i === 2){
                result.style.display = "block";
                download.href = result.toDataURL("image/png");
                download.style.display = "block";
            }
        };
        img.src = src;
    });
}

startBtn.onclick = startBooth;
startCamera();
</script>

</body>
</html>
