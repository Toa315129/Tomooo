<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TOMOPHOTO | Mall Photo Booth</title>

<!-- ===================================================== -->
<!-- ===================== THEME ========================= -->
<!-- ===================================================== -->
<style>

/* ---------- ROOT VARIABLES ---------- */
:root{
    --dark:#2a1a12;
    --brown:#5b3a29;
    --brown-soft:#8c6b4e;
    --cream:#f4eee8;
    --frame:#d8c6b8;
    --shadow:rgba(0,0,0,.35);
}

/* ---------- RESET ---------- */
*{
    box-sizing:border-box;
    margin:0;
    padding:0;
    user-select:none;
    -webkit-user-select:none;
}

/* ---------- BODY ---------- */
body{
    width:100vw;
    height:100vh;
    background:var(--dark);
    display:flex;
    justify-content:center;
    align-items:center;
    font-family:Arial, Helvetica, sans-serif;
}

/* ===================================================== */
/* ===================== BOOTH ========================== */
/* ===================================================== */

.booth-shell{
    width:460px;
    height:92vh;
    max-height:860px;
    background:var(--cream);
    border-radius:28px;
    box-shadow:0 30px 70px rgba(0,0,0,.6);
    padding:22px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
}

/* ---------- HEADER ---------- */
.header{
    text-align:center;
}

.header h1{
    font-size:24px;
    letter-spacing:6px;
    color:var(--brown);
}

.header p{
    font-size:11px;
    margin-top:4px;
    opacity:.6;
}

/* ===================================================== */
/* ===================== CAMERA ========================= */
/* ===================================================== */

.camera-section{
    position:relative;
    border:6px solid var(--brown);
    border-radius:22px;
    overflow:hidden;
    box-shadow:inset 0 0 0 4px #fff;
}

video{
    width:100%;
    height:auto;
    display:block;
}

/* ---------- COUNTDOWN ---------- */
.countdown{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,.35);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:160px;
    font-weight:bold;
    color:white;
    text-shadow:0 0 25px black;
    display:none;
    z-index:5;
}

/* ===================================================== */
/* ===================== CONTROL PANEL ================= */
/* ===================================================== */

.control-panel{
    display:flex;
    justify-content:space-around;
    margin-top:14px;
}

.control-btn{
    width:78px;
    height:78px;
    border-radius:50%;
    border:none;
    background:radial-gradient(circle at top,
        #a98a6a,
        var(--brown-soft)
    );
    color:white;
    font-size:11px;
    letter-spacing:1px;
    cursor:pointer;
    box-shadow:
        inset 0 2px 4px rgba(255,255,255,.4),
        inset 0 -4px 6px rgba(0,0,0,.3),
        0 6px 12px var(--shadow);
}

.control-btn:active{
    transform:translateY(2px);
    box-shadow:0 4px 8px var(--shadow);
}

.control-btn:disabled{
    opacity:.35;
    cursor:not-allowed;
    transform:none;
}

/* ===================================================== */
/* ===================== RESULT ========================= */
/* ===================================================== */

.result-section{
    margin-top:14px;
    display:flex;
    justify-content:center;
}

canvas{
    width:100%;
    border-radius:18px;
    border:5px solid var(--brown);
    display:none;
    background:white;
}

/* ---------- FOOTER ---------- */
.footer{
    text-align:center;
    font-size:10px;
    opacity:.55;
    margin-top:8px;
}

</style>
</head>

<body>

<!-- ===================================================== -->
<!-- ===================== STRUCTURE ===================== -->
<!-- ===================================================== -->

<div class="booth-shell">

    <div class="header">
        <h1>TOMOPHOTO</h1>
        <p>MALL PHOTO BOOTH SYSTEM</p>
    </div>

    <div class="camera-section">
        <video id="video" autoplay playsinline></video>
        <div class="countdown" id="countdown">3</div>
    </div>

    <div class="control-panel">
        <button class="control-btn" id="startBtn">●<br>START</button>
        <button class="control-btn" id="saveBtn" disabled>⬇<br>SAVE</button>
        <button class="control-btn" id="resetBtn" disabled>↺<br>RESET</button>
    </div>

    <div class="result-section">
        <canvas id="strip"></canvas>
    </div>

    <div class="footer">
        © TOMOPHOTO — professional booth
    </div>

</div>

<!-- ===================================================== -->
<!-- ===================== LOGIC ========================= -->
<!-- ===================================================== -->
<script>

/* ===================================================== */
/* ===================== STATE ========================== */
/* ===================================================== */

const STATE = {
    IDLE: "idle",
    COUNTDOWN: "countdown",
    CAPTURING: "capturing",
    BUILDING: "building",
    READY: "ready"
};

let currentState = STATE.IDLE;

/* ===================================================== */
/* ===================== ELEMENTS ======================= */
/* ===================================================== */

const video = document.getElementById("video");
const countdownEl = document.getElementById("countdown");
const startBtn = document.getElementById("startBtn");
const saveBtn = document.getElementById("saveBtn");
const resetBtn = document.getElementById("resetBtn");
const strip = document.getElementById("strip");

const stripCtx = strip.getContext("2d");
const tempCanvas = document.createElement("canvas");
const tempCtx = tempCanvas.getContext("2d");

/* ===================================================== */
/* ===================== DATA =========================== */
/* ===================================================== */

let photos = [];
const TOTAL_PHOTOS = 3;
const COUNTDOWN_TIME = 3;

/* ===================================================== */
/* ===================== CAMERA ========================= */
/* ===================================================== */

async function initCamera(){
    const stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:"user" }
    });
    video.srcObject = stream;
}

/* ===================================================== */
/* ===================== UTIL =========================== */
/* ===================================================== */

function sleep(ms){
    return new Promise(r=>setTimeout(r,ms));
}

/* ===================================================== */
/* ===================== COUNTDOWN ====================== */
/* ===================================================== */

async function runCountdown(){
    countdownEl.style.display="flex";
    for(let i=COUNTDOWN_TIME;i>0;i--){
        countdownEl.textContent=i;
        await sleep(1000);
    }
    countdownEl.style.display="none";
}

/* ===================================================== */
/* ===================== CAPTURE ======================== */
/* ===================================================== */

function captureFrame(){
    tempCanvas.width = video.videoWidth;
    tempCanvas.height = video.videoHeight;
    tempCtx.drawImage(video,0,0);
    photos.push(tempCanvas.toDataURL("image/png"));
}

/* ===================================================== */
/* ===================== BUILD STRIP ==================== */
/* ===================================================== */

function buildStrip(){
    const w = tempCanvas.width;
    const h = tempCanvas.height;
    const pad = 22;

    strip.width = w + pad*2;
    strip.height = h*TOTAL_PHOTOS + pad*(TOTAL_PHOTOS+1);

    stripCtx.fillStyle="#fff";
    stripCtx.fillRect(0,0,strip.width,strip.height);

    photos.forEach((src,i)=>{
        const img = new Image();
        img.onload = ()=>{
            const y = pad + i*(h+pad);

            stripCtx.fillStyle="#eee";
            stripCtx.fillRect(pad-6,y-6,w+12,h+12);

            stripCtx.drawImage(img,pad,y,w,h);

            if(i === TOTAL_PHOTOS-1){
                strip.style.display="block";
                saveBtn.disabled = false;
                resetBtn.disabled = false;
                currentState = STATE.READY;
            }
        };
        img.src = src;
    });
}

/* ===================================================== */
/* ===================== FLOW =========================== */
/* ===================================================== */

async function startBooth(){
    if(currentState !== STATE.IDLE) return;

    currentState = STATE.CAPTURING;
    photos = [];
    strip.style.display="none";

    startBtn.disabled = true;
    saveBtn.disabled = true;
    resetBtn.disabled = true;

    for(let i=0;i<TOTAL_PHOTOS;i++){
        currentState = STATE.COUNTDOWN;
        await runCountdown();

        currentState = STATE.CAPTURING;
        captureFrame();
        await sleep(500);
    }

    currentState = STATE.BUILDING;
    buildStrip();

    startBtn.disabled = false;
}

/* ===================================================== */
/* ===================== BUTTONS ======================== */
/* ===================================================== */

startBtn.onclick = startBooth;

saveBtn.onclick = ()=>{
    const a = document.createElement("a");
    a.download = "TOMOPHOTO.png";
    a.href = strip.toDataURL("image/png");
    a.click();
};

resetBtn.onclick = ()=>{
    photos = [];
    strip.style.display="none";
    saveBtn.disabled = true;
    resetBtn.disabled = true;
    currentState = STATE.IDLE;
};

/* ===================================================== */
/* ===================== INIT =========================== */
/* ===================================================== */

initCamera();

</script>
</body>
</html>
